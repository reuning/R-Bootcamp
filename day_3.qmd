---
title: "Introduction to R: Plotting"
format: revealjs
revealjs-plugins:
  - codefocus
---

```{R}
#| include: false 
library(readr)
df  <- read_csv("images/qog_bas_cs_jan22.csv")
```

## Goals for Today

- Understand how to make a variety of basic plots (scatter and bar)
- Manipulate data (relabeling)
- Export graphs

# Data for Today 

Today we are going to keep using a subset of country data from [The Quality of Governance Institute](https://www.gu.se/en/quality-government/qog-data).

- Download the [data we'll be using here](images/country_data.csv)
- You can open it with `read_csv()` and if you need more help check out the [first day of slides.](day_1.qmd)
- There is a description of all the [variables I've included here.](https://kevinreuning.com/presentations/pages/country_data.html) 


```{r}
library(tidyverse)
setwd("images")
df <- read_csv("country_data.csv")
```


## From Last Week

Our groups could have better names than 0, 1, 2, and 3. 

```{r}
df %>% filter(!is.na(br_elect)) %>% 
    group_by(br_elect) %>% 
    summarize(mean=mean(mad_gdppc, na.rm=T), n = n())
```



# Changing variables

## `mutate()`

If we want to change the values of a variable we use `mutate()`

General format: 

``mutate(new_var = f(old_var))`` 

. . . 

What function though? `br_elect` is a small set of numbers where each represent a category. This is a factor.  

## Applying `factor()`

`factor()` creates a factor, with a certain set of numeric levels, and labels and so needs somethings:

- The variable you are change (the first thing).
- The set of numeric levels in the variable. `levels=c( )`
- Labels you want to apply to the levels. `labels=c( )` 

## Example of Factor 

```{R}
library(tidyverse)
df %>% mutate(br_elect_label = 
        factor(br_elect, levels=c(0, 1, 2, 3), 
                labels=c("None", "Single-party", 
                "Non-dem multi-party", "Democratic"))) %>%
    pull(br_elect_label)
```

## Making better labels


```{R}
df %>% filter(!is.na(br_elect)) %>% 
    mutate(br_elect_label = 
            factor(br_elect, levels=c(0, 1, 2, 3), 
                    labels=c("None", "Single-party", 
                    "Non-dem multi-party", "Democratic"))) %>% 
    group_by(br_elect_label) %>% 
    summarize(mean=mean(mad_gdppc, na.rm=T), n = n())
```

## More Complicated Situations 

Often there are variables we want to _coarsen_ (take from interval and put them into categories), here we can use the `cut()` function to **cut** our variable up into categories. 

There are a variety of ways to `cut()` the most common way is giving it a set of "breaks" where you tell it where you want the bins to be.

```{r}
set.seed(1) ## Lets me recreate the exact random variables
vector <- rnorm(100) # creating a bunch of random variables 
cut_vector <- cut(vector, breaks=c(-4,-1, -0.5, 0, 0.5, 1, 4))
table(cut_vector)
```

## Adding Labels

You can also add labels to it, but remember **N** breaks creates **N-1** labels. 

```{r}

set.seed(2)
vector <- rnorm(100)
cut_vector <- cut(vector, breaks=c(-4,-1, -0.5, 0, 0.5, 1, 4), 
    labels=c("Lowest", "Low", "Mid-Low", 
            "Mid-High", "High", "Highest"))
table(cut_vector)

```

## Using Cut in Mutate


```{r}
df %>% mutate(
    corrupt = cut(ti_cpi, breaks=c(0, 33, 66, 100), 
            labels=c("Low", "Mid", "High"))
            ) %>%
    group_by(corrupt) %>% 
    summarize(mean=mean(mad_gdppc, na.rm=T), n = n())

```

## Check 

There is a variable that captures the fertility rate, mutate it into a variable with 3 categories one that is around replacement rate (2.1), one that is below it, and one that is above it. 

Then `group_by()` that new variable and count up how many observations in each bin. 

(it might help to use `range()` before identifying the bins)

## My Solution

```{r}
df %>% mutate(
    fert_groups = cut(wdi_fertility, breaks=c(0, 1.8, 2.4, Inf), 
            labels=c("Below", "Replacement", "Above"))
            ) %>%
    group_by(fert_groups) %>% 
    summarize(n = n())

```

# **ggplot2** 


## **ggplot2** Introduction 

We are going to use another library today: **ggplot2**

> ggplot2 is a system for declaratively creating graphics, based on The Grammar of Graphics. You provide the data, tell ggplot2 how to map variables to aesthetics, what graphical primitives to use, and it takes care of the details. ^[https://ggplot2.tidyverse.org/]

```{R}
library(tidyverse) # will load ggplot2 as well 
#library(ggplot2) # to just load ggplot 
```

## **ggplot2** Basics

Every plot is going to start with a call to `ggplot()` with the arguments that identify the data you want to use and the **aesthetics** you want to use from that data.

We then tell it how to plot use that data by adding on `geom_*()` functions 

## Simple Plot

```{R}
#| output-location: column
ggplot(df, 
    aes(x=mad_gdppc)) +
    geom_histogram() 
```

::: {.fragment .current-only data-code-focus="1"}
Setting the data frame we are accessing 
:::

::: {.fragment .current-only data-code-focus="2"}
Identifying that we are going to use `mad_gdppc` as the x variable by using the `aes()` within `ggplot()` 
:::


::: {.fragment .current-only data-code-focus="3"}
Displaying that data as a histogram by adding `geom_histogram()`
:::

::: {.fragment .current-only data-code-focus="1-3"}
Remember things are linked together with `+` 
:::


## Modifying the Style and Labels

We should _always_ provide human readable labels on plots. You add `labs()` to set them. This has arguments for the x axis (`x=`), y axis (`y=`) and the title (`title=`)

. . .

```{r}
#| output-location: slide
ggplot(df, 
    aes(x=mad_gdppc)) +
    geom_histogram() + 
    labs(y="Frequency", x="GDP Per Capita", 
        title="Histogram of GDP per Capita")
```

## Themes

``ggplot`` has a large number of [themes](https://ggplot2.tidyverse.org/reference/ggtheme.html) that you can use to change the style of your plot. 

```{r}
#| output-location: column
ggplot(df, 
    aes(x=mad_gdppc)) +
    geom_histogram() + 
    labs(y="Frequency",
        x="GDP Per Capita", 
        title="Histogram of GDP per Capita") +
    theme_minimal()
```

## Different Theme

```{r}
#| output-location: column
ggplot(df, 
    aes(x=mad_gdppc)) +
    geom_histogram() + 
    labs(y="Frequency", 
        x="GDP Per Capita", 
        title="Histogram of GDP per Capita") +
    theme_dark()
```

## Adding more Aesthetics 

We can also modify the color and transparency of the bars to specific values by adding them to the `geom_histogram()` call

```{r}
ggplot(df, 
    aes(x=mad_gdppc)) +
    geom_histogram(fill="green", color="gray", 
            alpha=.5) + 
    labs(y="Frequency", x="GDP Per Capita", 
        title="Histogram of GDP per Capita") + 
    theme_minimal()
```

## Some Common Aesthetics

- `color=` the color of lines or points.
- `fill=` the fill in color.
- `alpha=` how transparent an object is (0 to 1, with 0 as invisible
- `linewidth=` how thick lines are
- `linetype=` the types of lines

[More info on this page](https://ggplot2.tidyverse.org/reference/geom_bar.html#aesthetics)

## Check 

Identify a different variable, make a histogram of, correct the labels, and change some of the other aesthetics. 

## My Answer

```{r}

ggplot(df, 
    aes(x=vdem_academ)) +
    geom_histogram(fill="gray", color="black") + 
    labs(y="Frequency", x="Academic Freedom (V-Dem)", 
        title="Histogram of Academic Freedom") + 
    theme_minimal()
```

# Scatter Plots and Scales

## Saving a Plot in R

Before going further it is helpful to know that you can save your plot (`p <- `) and then add more things to it:

```{r}
p1 <- ggplot(df, aes(x=vdem_academ)) 
p1 <- p1 + geom_histogram(fill="gray", color="black") 
p1 <- p1 + labs(y="Frequency", x="Acaddemic Freedom (V-Dem)", 
title="Histogram of Academic Freedom") 
p1 + theme_minimal() ## Calling the plot with a theme attached
``` 

## Modifying a Plot 

We can then try out other things more easily:
```{r}
p1 + theme_classic() #Switching to a new theme
```

## Scatter Plots

`geom_point()` is going to plot points at the `x` and `y` value you that you give it:

```{r}
ggplot(df, aes(x=vdem_academ, y=mad_gdppc)) + 
    geom_point()
```

## Aesthetics 

There are again a bunch of aesthetics, some of the new ones are:

- `shape=` the shape of the point (try some different numbers)
- `size=` the size of the point 

[More info](https://ggplot2.tidyverse.org/reference/geom_point.html#aesthetics)

## Aesthetics Example

```{r}
ggplot(df, aes(x=vdem_academ, y=mad_gdppc)) + 
    geom_point(color="purple", shape=4)
```

## Aesthetics with Other Variables

We can also set any of these aesthetics to reflect another variable
```{r}
ggplot(df, aes(x=vdem_academ, y=mad_gdppc, 
    color=fh_polity2)) + 
    geom_point(size=3)
```

. . .

We have a new label to fix. 

## Scales and Guides

Each aesthetics has associated functions that can be used to modify the `scale` it uses. `scale_color_gradient()` switches the colors to a gradient defined by a `high` color and a `low` color. 

```{r}
ggplot(df, aes(x=vdem_academ, y=mad_gdppc, 
    color=fh_polity2)) + 
    geom_point(size=3) + 
    scale_color_gradient(low="pink", high="black") 
```


## Scales and Guides Labels

The `scale_*_*()` variables all take a `name` argument as well, that is the first thing it expects so you can just put it in the first. 

```{r}
ggplot(df, aes(x=vdem_academ, y=mad_gdppc, 
    color=fh_polity2)) + 
    geom_point(size=3) + 
    scale_color_gradient("Democracy", 
    low="pink", high="black") 
```

## Other Scales

There are a lot of [scales](https://ggplot2.tidyverse.org/reference/index.html#scales) and often there are similar ones that apply to different aesthetics:

- `scale_color_gradient2()` and `scale_fill_gradient2()`
    - Allows you to set a midpoint
- `scale_x_log10()` and `scale_y_log`()` 
    - Log transformation of the scale on the x or y axis.
- `scale_color_manual()` and `scale_fill_manual()`
    - Manually pick colors for different categories
- `scale_color_brewer()` and `scale_fill_brewer()`
    - A selection of pallettes for categorical data. 

## Adding More Scales

```{r}
ggplot(df, aes(x=vdem_academ, y=mad_gdppc,color=fh_polity2)) + 
    geom_point(size=3) + scale_y_log10() +
    scale_color_gradient2("Democracy", 
    low="pink", mid="gray", high="green", midpoint = 5) +theme_minimal() + 
    labs(y="GDP per Cap\n(Log scale)", x="Academic Freedom", 
    title="GDP vs Academic Freedom")
```

## Check 

Pick two interval variables, and an additional variable (any type). Make a scatter plot of the variables using the third variable to color in the points. 

Label things nicely. 

# Combining Mutate and ggplot 

## Making Our Guides Nice

As discussed before, often the values of our variables don't make for good labels. The easiest way to relabel these is by adjusting the data _prior_ to making a plot. 

We can then pipe that data into our new plot

## Example {auto-animate=true}

```{.r}
df %>% filter(!is.na(br_elect)) %>% 
    mutate(br_elect_label = factor(br_elect, levels=c(0, 1, 2, 3), 
        labels=c("None", "Single-party", "Non-dem multi-party", "Democratic"))) %>% 
```


## Example {auto-animate=true}

```{.r}
df %>% filter(!is.na(br_elect)) %>% 
    mutate(br_elect_label = factor(br_elect, levels=c(0, 1, 2, 3), 
        labels=c("None", "Single-party", "Non-dem multi-party", "Democratic"))) %>% 
    ggplot(aes(x=vdem_academ, y=mad_gdppc, color=br_elect_label)) + 
    geom_point() + 
    scale_color_brewer("Election Type", type="qual", palette = 3) +theme_minimal() + 
    labs(y="GDP per Cap\n(Log scale)", x="Academic Freedom", 
    title="GDP vs Academic Freedom")
```

## Example {auto-animate=true}

```{r}
df %>% filter(!is.na(br_elect)) %>% 
    mutate(br_elect_label = factor(br_elect, levels=c(0, 1, 2, 3), 
        labels=c("None", "Single-party", "Non-dem multi-party", "Democratic"))) %>% 
    ggplot(aes(x=vdem_academ, y=mad_gdppc, color=br_elect_label)) + 
    geom_point() + 
    scale_color_brewer("Election Type", type="qual", palette = 3) +theme_minimal() + 
    labs(y="GDP per Cap\n(Log scale)", x="Academic Freedom", 
    title="GDP vs Academic Freedom")
```

# Smooths and Grouping

## Showing a trend

`geom_smooth()` can be used to add a trend line to our data. 

```{r}
p <- ggplot(df, aes(x=vdem_academ, y=mad_gdppc,color=fh_polity2)) + 
    geom_point(size=3) 
p + geom_smooth()
```

## Dangers of `geom_smooth()`

`geom_smooth()` is very powerful, but it is easy to have no idea what you are doing with it as defining `trend` is really hard. 

You change the type of trend it makes using the `method=` argument

## Different Smooths - Linear

```{r}
# Linear regression is "lm"
p + geom_smooth(method="lm") 
```

## Different Smooths - Loess line

```{r}
# A local regression line is "loess"
p + geom_smooth(method="loess") 
```

## Different Smooths - Spline

```{r}
# A spline is "gam"
p + geom_smooth(method="gam") 
```

---



::: {.callout-warning}
If you cannot explain what is happening to make that line then you should probably avoid using it. 
:::

## Multiple Smooths

If we have multiple types of observations, we can plot smooths for each one by setting `group=` to that variable. 


```{.r}
df <- df %>% mutate(
    fert_groups = cut(wdi_fertility, breaks=c(0, 1.8, 2.4, Inf), 
            labels=c("Below", "Replacement", "Above"))
            ) %>%
    group_by(fert_groups) %>% drop_na(fert_groups)
p <- ggplot(df, aes(x=vdem_academ, y=mad_gdppc,color=fh_polity2)) + 
    geom_point(size=3) 
p + geom_smooth(aes(group=fert_groups))
```
::: {.callout-note}
You can use `aes()` in a `geom_*()` if you want to specify something for just that part of the plot.
:::

## Multiple Smooths

```{r}
#| echo: false
df <- df %>% mutate(
    fert_groups = cut(wdi_fertility, breaks=c(0, 1.8, 2.4, Inf), 
            labels=c("Below", "Replacement", "Above"))
            ) %>%
    group_by(fert_groups) %>% drop_na(fert_groups)
p <- ggplot(df, aes(x=vdem_academ, y=mad_gdppc,color=fh_polity2)) + 
    geom_point(size=3) 
p + geom_smooth(aes(group=fert_groups))
```



## Multiple Smooths Improved

```{r}
p <- ggplot(df, aes(x=vdem_academ, y=mad_gdppc,  group=fert_groups, color=fert_groups)) + 
    geom_point(size=3) 
p + geom_smooth(method="lm")
```

# Facets

## Introduction

Sometimes it is easier to understand the groups if you create individual plots for each group. We call these plots facet and make them with `facet_wrap()` 

To identify what groups to make you put `~variable`. 

## Example

```{r}
# using plot from previous one still. 
p + geom_smooth(method="lm") +
    facet_wrap(~fert_groups)
```

## Check 

Pick two interval variables, and an additional variable (any type). Make a scatter plot of the variables using the third variable to color in the points. 

Add a smooth, and facet on a variable as well. 

Don't forget labels. 


# Everything together

```{r}
#| echo: true
#| fig-align: center
#| output-location: slide
df %>% 
    mutate(type = cut(fh_polity2,  breaks=c(0, 3, 7, 10), 
                        labels=c("Autocracy", "Anocracy", "Democracy"))) %>% 
    drop_na(type) %>%  
    ggplot(aes(y=wdi_afp, x=mad_gdppc)) + 
    geom_smooth(method="lm", color='black') + 
    geom_point(color='orangered3') + 
    facet_wrap(~type) + 
    scale_x_log10(labels=scales::label_dollar()) +
    theme_minimal() + theme(strip.text=element_text(size=20)) + 
    labs(y="Percent of Labor\nForce in Military", 
    x="GDP per Capita\n(Log scale)") 
```

::: {.fragment .current-only data-code-focus="2-3"}
Mutating our variables
:::

::: {.fragment .current-only data-code-focus="4"}
Dropping variables with missing values
:::

::: {.fragment .current-only data-code-focus="5"}
Setting my `x` and `y` variables
:::

::: {.fragment .current-only data-code-focus="6"}
Creating a linear regression line, in black.
:::

::: {.fragment .current-only data-code-focus="7"}
Scatter plot with nice colors
:::

::: {.fragment .current-only data-code-focus="8"}
Facet on `type`
:::


::: {.fragment .current-only data-code-focus="9"}
Change the x-axis to be logged and make the axis labels nicer.
:::

::: {.fragment .current-only data-code-focus="10"}
Setting the theme up
:::

::: {.fragment .current-only data-code-focus="11-12"}
Labels!
:::


# Saving Plots

## Two ways to save plots

- Rstudio has an "export" button above the plots that you can use. 
- Call `ggsave()` with a file name:

```{.r}
p <- ggplot(...
ggsave(filename="file.png", plot=p, width=6, 
    height=4, units="in")
```
Saves plot `p` as a png, with a size of 6 by 4 inches. 

## Additional Help

- References/tutorials: <https://ggplot2.tidyverse.org/>

- Book that discusses principles of data viz and ggplot2: <https://socviz.co/>


# Principles of Better Graphics

## General principles: Less is usually more

Less is usually more

-   Plots don't need to have a lot of bells and whistle.
-   You are should direct attention to what is important.
-   At the same time\...
    -   Everything should have a label
    -   You can use grid lines to highlight (relevant differences

## General principles: Follow assumptions

People have assumptions about how plots work, don't break them unless you make it **very** clear that you are.


![](images/gun_violence.jpg){fig-align="center"}


## Some Assumptions

Some assumptions people make: 

- If one of the variables is time, it usually is on the x-axis.
- The further you are from the bottom left the higher the number.
- The axis are continuous (and often linear)

## Example - Breaking Assumptions

![](images/flipped_1.png){fig-align="center"}


## Example - Following Assumptions

General principles: Follow assumptions

![](images/flipped_2.png){fig-align="center"}

## General principles: Make it clear

Make it clear to the viewer what they are supposed to take away from it.

- If they should look at trends, add a trend line

- If they are making comparisons across groups put those groups together

## Example: Making it Unclear 

![](images/comparisons_1.png){fig-align="center"}

## Example: Making it clear 

![](images/comparisons_2.png){fig-align="center"}

## Longer Example - Local Party Social Media

\normalsize 
- Interested in how local parties in the US use social media.
- Collected social media info for  6,000 local parties.
- Used Crowdtangle to download all their facebook posts from 2016 to 2021.
- Dataset contained 3,907,203 posts with 26 variables per post.

\footnotesize 
Co-Authors: Anne Whitesell (Miami University); Lee A. Hannah (Wright State University)


## Social Media Data

Social media data can be very interesting:

- We have the text of the posts.
- We have the reactions to the post (number of likes, comments shares)
- We have the *exact* time the post was made.
:::

## Looking at Trends

Always good to look at trends in data: 
-  Calculate daily number of posts.
-  Calculate the average number of reactions per post per day.


## Some of the code

```{.r}
p1 <- ggplot(tmp, aes(x=lubridate, y=N, fill=Party, 
    color=Party, shape=Party)) + 
    geom_point(alpha=.2) + geom_smooth(size=1,method = loess,
    method.args=list("span" =.5)) + 
    theme_minimal() + 
    scale_y_continuous(labels = scales::label_comma()) + 
    scale_color_manual("Party",
    values=col_pal)  + 
    scale_fill_manual(values=col_pal) + 
    # geom_vline(xintercept = lubridate::as_date("2020-11-03"), linetype="dashed") + 
    labs(y="Number of Posts", x="")
```


## Plot 

![](images/all_posts.png){fig-align="center"}

